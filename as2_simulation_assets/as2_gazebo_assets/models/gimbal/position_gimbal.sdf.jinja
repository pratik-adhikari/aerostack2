<model name="{{ sensor.name }}">
    <pose
        relative_to="base_link">
        {{ sensor.pose }}
    </pose>
    <link name="mount_link">
        <inertial>
        <pose>-0.02552 0 -0.08136 0 0 0</pose>
        <mass>1e-6</mass>
        <inertia>
            <ixx>8.33e-06</ixx>
            <ixy>0</ixy>
            <ixz>0</ixz>
            <iyy>8.33e-06</iyy>
            <iyz>0</iyz>
            <izz>8.33e-06</izz>
        </inertia>
        <visual name="mount_visual">
            <geometry>
            <mesh>
                <scale>0.001 0.001 0.001</scale>
                <uri>model://gimbal/meshes/{{ sensor.mount_mesh|default("gimbal_mount.stl") }}</uri>
            </mesh>
            </geometry>
            <material>
            <ambient>.175 .175 .175 1.0</ambient>
            <diffuse>.175 .175 .175 1.0</diffuse>
            <specular>.175 .175 .175 1.0</specular>
            </material>
        </visual>
        </inertial>
    </link>

    <model name="_0">
        <link name="yaw_roll_link">
            <inertial>
            <pose>0 0 -0.1283 0 0 0</pose>
            <mass>1e-6</mass>
            <inertia>
                <ixx>8.33e-06</ixx>
                <ixy>0</ixy>
                <ixz>0</ixz>
                <iyy>8.33e-06</iyy>
                <iyz>0</iyz>
                <izz>8.33e-06</izz>
            </inertia>
            </inertial>
            <visual name="yaw_roll_visual">
            <geometry>
                <mesh>
                <scale>0.001 0.001 0.001</scale>
                <uri>model://gimbal/meshes/{{ sensor.vertical_mesh|default("gimbal_vertical_arm.stl") }}</uri>
                </mesh>
            </geometry>
            <material>
                <ambient>.175 .175 .175 1.0</ambient>
                <diffuse>.175 .175 .175 1.0</diffuse>
                <specular>.175 .175 .175 1.0</specular>
            </material>
            </visual>
        </link>

        <model name="_1">
            <link name="roll_pitch_link">
                <inertial>
                <pose>-0.0213 0 -0.162 0 0 0</pose>
                <mass>1e-6</mass>
                <inertia>
                    <ixx>8.33e-06</ixx>
                    <ixy>0</ixy>
                    <ixz>0</ixz>
                    <iyy>8.33e-06</iyy>
                    <iyz>0</iyz>
                    <izz>8.33e-06</izz>
                </inertia>
                </inertial>
                <visual name="roll_pitch_visual">
                <geometry>
                    <mesh>
                    <scale>0.001 0.001 0.001</scale>
                    <uri>model://gimbal/meshes/{{ sensor.horizontal_mesh|default("gimbal_horizontal_arm.stl") }}</uri>
                    </mesh>
                </geometry>
                <material>
                    <ambient>.175 .175 .175 1.0</ambient>
                    <diffuse>.175 .175 .175 1.0</diffuse>
                    <specular>.175 .175 .175 1.0</specular>
                </material>
                </visual>
            </link>

            <model name="_2">
                <link name="{{ sensor.sensor_attached }}_enu_link">
                    <inertial>
                    <pose>-0.0412 0 -0.162 0 0 0</pose>
                    <mass>1e-6</mass>
                    <inertia>
                        <ixx>8.33e-06</ixx>
                        <ixy>0</ixy>
                        <ixz>0</ixz>
                        <iyy>8.33e-06</iyy>
                        <iyz>0</iyz>
                        <izz>8.33e-06</izz>
                    </inertia>
                    </inertial>
                    <collision name="{{ sensor.sensor_attached }}_enu_link_collision">
                    <pose>-0.0412 0 -0.162 0 0 0</pose>
                    <geometry>
                        <sphere>
                        <radius>0.035</radius>
                        </sphere>
                    </geometry>
                    <surface>
                        <friction>
                        <ode>
                            <mu>1</mu>
                            <mu2>1</mu2>
                        </ode>
                        </friction>
                        <contact>
                        <ode>
                            <kp>1e+8</kp>
                            <kd>1</kd>
                            <max_vel>0.01</max_vel>
                            <min_depth>0.001</min_depth>
                        </ode>
                        </contact>
                    </surface>
                    </collision>
                    <visual name="{{ sensor.sensor_attached }}_enu_visual">
                    <geometry>
                        <mesh>
                        <scale>0.001 0.001 0.001</scale>
                        <uri>model://gimbal/meshes/{{ sensor.camera_mesh|default("gimbal_camera.stl") }}</uri>
                        </mesh>
                    </geometry>
                    <material>
                        <ambient>.175 .175 .175 1.0</ambient>
                        <diffuse>.175 .175 .175 1.0</diffuse>
                        <specular>.175 .175 .175 1.0</specular>
                    </material>
                    </visual>
                </link>
                {% if sensor.sensor_attached_type == 'hd_camera' -%}

                    {% include 'hd_camera/hd_camera.sdf.jinja' with context -%}

                {% elif sensor.sensor_attached_type == 'vga_camera' -%}

                    {% include 'vga_camera/vga_camera.sdf.jinja' with context -%}

                {% elif sensor.sensor_attached_type == 'semantic_camera' -%}

                    {% include 'semantic_camera/semantic_camera.sdf.jinja' with context -%}

                {% elif sensor.sensor_attached_type == 'rgbd_camera' -%}

                    {% include 'rgbd_camera/rgbd_camera.sdf.jinja' with context -%}

                {% else -%}

                    <include>
                        <name>{{ sensor.sensor_attached }}</name>
                        <uri>model://{{ sensor.sensor_attached_type }}</uri>
                        <pose
                            relative_to="{{ sensor.sensor_attached }}_enu_link">
                            {{ sensor.pose }}
                            {#- FIXME: using gimbal pose instead gimbaled_sensor pose -#}
                        </pose>
                    </include>

                {% endif -%}

            </model>
        </model>
    </model>
</model>

<joint name="{{ sensor.name }}_joint" type="fixed">
    <parent>base_link</parent>
    <child>{{ sensor.name }}::mount_link</child>
</joint>

<!-- mount to roll Joint -->
<joint name="{{ sensor.name }}_yaw_joint" type="revolute">
    <parent>{{ sensor.name }}::mount_link</parent>
    <child>{{ sensor.name }}::_0::yaw_roll_link</child>
    <pose>-0.02552 0 0 0 0 0</pose>
    <axis>
      <xyz>0 0 -1</xyz>
      <limit>
        <lower>-1e+16</lower>
        <upper>1e+16</upper>
        <effort>100</effort>
        <velocity>-1</velocity>
      </limit>
      <dynamics>
        <damping>0.1</damping>
      </dynamics>
    </axis>
  <physics>
    <ode>
      <implicit_spring_damper>1</implicit_spring_damper>
      <limit>
        <cfm>0.1</cfm>
        <erp>0.2</erp>
      </limit>
    </ode>
  </physics>
</joint>

<!-- roll to pitch Joint -->
<joint name="{{ sensor.name }}_roll_joint" type="revolute">
    <parent>{{ sensor.name }}::_0::yaw_roll_link</parent>
    <child>{{ sensor.name }}::_0::_1::roll_pitch_link</child>
    <pose>0 0 -0.1619 0 0 0</pose>
    <axis>
      <xyz>-1 0 0</xyz>
      <limit>
        <lower>-0.785398</lower>
        <upper>0.785398</upper>
        <effort>100</effort>
        <velocity>-1</velocity>
      </limit>
      <dynamics>
        <damping>0.1</damping>
      </dynamics>
    </axis>
    <physics>
      <ode>
        <implicit_spring_damper>1</implicit_spring_damper>
        <limit>
          <cfm>0.1</cfm>
          <erp>0.2</erp>
        </limit>
      </ode>
    </physics>
</joint>

<!-- Roll to Sensor Model Joint -->
<joint name="{{ sensor.name }}_pitch_joint" type="revolute">
    <parent>{{ sensor.name }}::_0::_1::roll_pitch_link</parent>
    <child>{{ sensor.name }}::_0::_1::_2::{{ sensor.sensor_attached }}_enu_link</child>
    <pose>-0.0412 0 -0.162 0 0 0</pose>
    <axis>
      <xyz>0 1 0</xyz>
      <limit>
        <lower>-2.35619</lower>
        <upper>0.7854</upper>
        <effort>100</effort>
        <velocity>-1</velocity>
      </limit>
      <dynamics>
        <damping>0.1</damping>
      </dynamics>
    </axis>
    <physics>
      <ode>
        <implicit_spring_damper>1</implicit_spring_damper>
        <limit>
          <cfm>0.1</cfm>
          <erp>0.2</erp>
        </limit>
      </ode>
    </physics>
</joint>

<!-- Sensor Model to Link Joint -->
<joint name="{{ sensor.sensor_attached }}_joint" type="fixed">
    <parent>{{ sensor.name }}::_0::_1::_2::{{ sensor.sensor_attached }}_enu_link</parent>
    <child>{{ sensor.name }}::_0::_1::_2::{{ sensor.sensor_attached }}::{{ sensor.sensor_attached_type }}</child>
</joint>

<!-- Gimbal Joint State Publisher -->
<plugin filename="libignition-gazebo-joint-state-publisher-system"
    name="ignition::gazebo::systems::JointStatePublisher">
    <joint_name>{{ sensor.name }}_roll_joint</joint_name>
    <joint_name>{{ sensor.name }}_pitch_joint</joint_name>
    <joint_name>{{ sensor.name }}_yaw_joint</joint_name>
</plugin>

<!-- Roll Joint Position Controller -->
<plugin
    filename="ignition-gazebo-joint-position-controller-system"
    name="gz::sim::systems::JointPositionController">
    <joint_name>{{ sensor.name }}_roll_joint</joint_name>
    <topic>/{{ namespace }}/{{ sensor.name }}/gimbal_cmd/position/0</topic>
    <p_gain>1.0</p_gain>
    <i_gain>0.0</i_gain>
    <d_gain>0.5</d_gain>
    <cmd_max>1</cmd_max>
    <cmd_min>1</cmd_min>
    <use_velocity_commands>true</use_velocity_commands>
</plugin>

<!-- Pitch Joint Position Controller -->
<plugin
    filename="ignition-gazebo-joint-position-controller-system"
    name="gz::sim::systems::JointPositionController">
    <joint_name>{{ sensor.name }}_pitch_joint</joint_name>
    <topic>/{{ namespace }}/{{ sensor.name }}/gimbal_cmd/position/1</topic>
    <p_gain>1.0</p_gain>
    <i_gain>0.0</i_gain>
    <d_gain>0.5</d_gain>
    <cmd_max>1</cmd_max>
    <cmd_min>1</cmd_min>
    <use_velocity_commands>true</use_velocity_commands>
</plugin>

<!-- Yaw Joint Position Controller -->
<plugin
    filename="ignition-gazebo-joint-position-controller-system"
    name="gz::sim::systems::JointPositionController">
    <joint_name>{{ sensor.name }}_yaw_joint</joint_name>
    <topic>/{{ namespace }}/{{ sensor.name }}/gimbal_cmd/position/2</topic>
    <p_gain>1.0</p_gain>
    <i_gain>0.0</i_gain>
    <d_gain>0.5</d_gain>
    <cmd_max>1</cmd_max>
    <cmd_min>1</cmd_min>
    <use_velocity_commands>true</use_velocity_commands>
</plugin>